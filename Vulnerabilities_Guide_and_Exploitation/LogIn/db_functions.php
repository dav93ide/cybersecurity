<?php
	if(!isset($_REQUEST)){
		header("location: 404.php");
	}
	
	// Crea DB E Tabelle
	function initDB(){
		$con = new mysqli('localhost:3306','root','');
		$con -> query('CREATE DATABASE IF NOT EXISTS user_db');
		$con -> select_db('user_db');
		$con ->query('CREATE TABLE IF NOT EXISTS usertab(id INT NOT NULL AUTO_INCREMENT, name varchar(20) NOT NULL, pass VARCHAR(32) NOT NULL, registrazione DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, PRIMARY KEY(id), UNIQUE(name))');
		$con ->close();
	}
	
	// Controlla Esistenza Del DB
	function checkDB(){
		if($db = new mysqli('localhost:3306','root')){
			if(!$db-> select_db('user_db')){
				initDB();
			}
		}
	}
	
	// Inserisce username/password In Tabella Utenti Registrati
	function insertUserDB($name,$pass){
		$db = new mysqli('localhost:3306','root','','user_db');
		$db -> query('INSERT INTO usertab(name,pass) VALUES (\''.$name.'\',\''.$pass.'\')');
		$db->close();
	}
	
	// Esegue L'Autenticazione Per Il Log-In
	function loginDB1($name, $pass){
		$db = new mysqli('localhost:3306','root', '', 'user_db');
		$passhash = hash('md5', $pass);
		$ris = $db->query("SELECT name,pass FROM usertab WHERE name = '$name' AND pass = '$passhash'");
		$arr =  $ris-> fetch_assoc();
		if($arr){
			$_SESSION['username'] = $arr['name'];
			return True;
		}
		else{
			return False;
		}
		$ris -> close();
		$db->close();
	}
	
	function loginDB2($name,$pass){
		$db = new mysqli('localhost:3306','root', '', 'user_db');
		$passhash = hash('md5', $pass);
		$ris = $db->query("SELECT name,pass FROM usertab WHERE name = '$name'");
		$arr =  $ris-> fetch_assoc();
		if($arr['pass'] == $passhash ){
			$_SESSION['username'] = $arr['name'];
			return True;
		}
		else{
			return False;
		}
		$ris -> close();
		$db->close();
	}
	
	function changePass($name,$pass){
		$db = new mysqli('localhost:3306','root', '', 'user_db');
		$passhash = hash('md5', $pass);
		$db->query("UPDATE usertab SET pass='$passhash' WHERE name='$name'");
		$db->close();
	}
	
?>